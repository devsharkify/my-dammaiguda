<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="min-h-screen flex items-center justify-center">
            <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="h-16 w-16 gradient-bg rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-newspaper text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">News Admin</h1>
                    <p class="text-gray-500">Sign in to manage news</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username" required
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" required
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                    </div>
                    <button type="submit" 
                        class="w-full py-3 gradient-bg text-white rounded-xl font-semibold hover:opacity-90 transition">
                        Sign In
                    </button>
                </form>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden"></p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <header class="gradient-bg text-white sticky top-0 z-50">
                <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-newspaper text-2xl"></i>
                        <h1 class="text-xl font-bold">News Dashboard</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="user-name" class="text-sm opacity-80"></span>
                        <button onclick="logout()" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </header>

            <div class="max-w-7xl mx-auto px-4 py-6">
                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-newspaper text-blue-500"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="stat-total">0</p>
                                <p class="text-xs text-gray-500">Total Articles</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-thumbtack text-green-500"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="stat-pinned">0</p>
                                <p class="text-xs text-gray-500">Pinned</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-red-500"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="stat-breaking">0</p>
                                <p class="text-xs text-gray-500">Breaking</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-eye text-purple-500"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold" id="stat-views">0</p>
                                <p class="text-xs text-gray-500">Total Views</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Article Form -->
                <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-plus-circle text-purple-500"></i>
                        Create New Article
                    </h2>
                    <form id="article-form" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title (English)</label>
                                <input type="text" id="art-title" required
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title (Telugu)</label>
                                <input type="text" id="art-title-te"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none">
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Summary (English)</label>
                                <textarea id="art-summary" required rows="3"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Summary (Telugu)</label>
                                <textarea id="art-summary-te" rows="3"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none"></textarea>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="art-category" required
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none">
                                    <option value="local">Local</option>
                                    <option value="city">City</option>
                                    <option value="state">State</option>
                                    <option value="national">National</option>
                                    <option value="sports">Sports</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="tech">Technology</option>
                                    <option value="health">Health</option>
                                    <option value="business">Business</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                                <input type="url" id="art-image"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Source Link</label>
                                <input type="url" id="art-link"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-purple-500 outline-none">
                            </div>
                        </div>
                        <div class="flex items-center gap-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="art-pinned" class="w-4 h-4 text-purple-500">
                                <span class="text-sm text-gray-700">Pin Article</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="art-breaking" class="w-4 h-4 text-red-500">
                                <span class="text-sm text-gray-700">Breaking News</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="sync-dammaiguda" class="w-4 h-4 text-green-500">
                                <span class="text-sm text-gray-700">Sync to My Dammaiguda</span>
                            </label>
                        </div>
                        <button type="submit" 
                            class="px-6 py-2 gradient-bg text-white rounded-lg font-semibold hover:opacity-90 transition">
                            <i class="fas fa-paper-plane mr-2"></i>Publish Article
                        </button>
                    </form>
                </div>

                <!-- Articles List -->
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-list text-purple-500"></i>
                            All Articles
                        </h2>
                        <button onclick="loadArticles()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <div id="articles-list" class="space-y-3">
                        <!-- Articles will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let token = localStorage.getItem('news_token');
        let currentUser = null;

        // Check auth on load
        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                checkAuth();
            }
        });

        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    currentUser = await res.json();
                    showDashboard();
                } else {
                    logout();
                }
            } catch (e) {
                logout();
            }
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser?.name || 'Admin';
            loadArticles();
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('news_token');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();
                if (res.ok && data.token) {
                    token = data.token;
                    currentUser = data.user;
                    localStorage.setItem('news_token', token);
                    showDashboard();
                } else {
                    errorEl.textContent = data.detail || 'Login failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'Connection error';
                errorEl.classList.remove('hidden');
            }
        });

        // Create Article
        document.getElementById('article-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const syncToDammaiguda = document.getElementById('sync-dammaiguda').checked;
            
            const article = {
                title: document.getElementById('art-title').value,
                title_te: document.getElementById('art-title-te').value || null,
                summary: document.getElementById('art-summary').value,
                summary_te: document.getElementById('art-summary-te').value || null,
                category: document.getElementById('art-category').value,
                image_url: document.getElementById('art-image').value || null,
                link: document.getElementById('art-link').value || null,
                is_pinned: document.getElementById('art-pinned').checked,
                is_breaking: document.getElementById('art-breaking').checked,
                source: 'News Admin'
            };

            try {
                const res = await fetch(`${API_URL}/news/admin/push?sync_to_app=${syncToDammaiguda}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(article)
                });

                if (res.ok) {
                    alert('Article published successfully!');
                    e.target.reset();
                    loadArticles();
                } else {
                    const data = await res.json();
                    alert(data.detail || 'Failed to publish');
                }
            } catch (e) {
                alert('Connection error');
            }
        });

        // Load Articles
        async function loadArticles() {
            try {
                const res = await fetch(`${API_URL}/news/admin/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    renderArticles(data.articles || []);
                    updateStats(data.articles || []);
                }
            } catch (e) {
                console.error('Failed to load articles', e);
            }
        }

        function updateStats(articles) {
            document.getElementById('stat-total').textContent = articles.length;
            document.getElementById('stat-pinned').textContent = articles.filter(a => a.is_pinned).length;
            document.getElementById('stat-breaking').textContent = articles.filter(a => a.is_breaking).length;
            document.getElementById('stat-views').textContent = articles.reduce((sum, a) => sum + (a.views || 0), 0);
        }

        function renderArticles(articles) {
            const container = document.getElementById('articles-list');
            
            if (articles.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No articles yet. Create your first article above!</p>';
                return;
            }

            container.innerHTML = articles.map(article => `
                <div class="border rounded-xl p-4 hover:shadow-md transition">
                    <div class="flex items-start gap-4">
                        ${article.image_url ? `<img src="${article.image_url}" class="w-20 h-20 rounded-lg object-cover flex-shrink-0">` : ''}
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                ${article.is_pinned ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Pinned</span>' : ''}
                                ${article.is_breaking ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">Breaking</span>' : ''}
                                <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">${article.category}</span>
                            </div>
                            <h3 class="font-semibold text-gray-800 truncate">${article.title}</h3>
                            <p class="text-sm text-gray-500 line-clamp-2">${article.summary}</p>
                            <div class="flex items-center gap-4 mt-2 text-xs text-gray-400">
                                <span><i class="fas fa-eye mr-1"></i>${article.views || 0} views</span>
                                <span><i class="fas fa-clock mr-1"></i>${article.time_ago || 'Just now'}</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="togglePin('${article.id}')" class="p-2 rounded-lg ${article.is_pinned ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'} hover:opacity-80">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <button onclick="deleteArticle('${article.id}')" class="p-2 rounded-lg bg-red-100 text-red-600 hover:opacity-80">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function togglePin(articleId) {
            try {
                await fetch(`${API_URL}/news/admin/${articleId}/pin`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadArticles();
            } catch (e) {
                console.error('Failed to toggle pin', e);
            }
        }

        async function deleteArticle(articleId) {
            if (!confirm('Are you sure you want to delete this article?')) return;

            try {
                await fetch(`${API_URL}/news/admin/${articleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadArticles();
            } catch (e) {
                console.error('Failed to delete', e);
            }
        }
    </script>
</body>
</html>
